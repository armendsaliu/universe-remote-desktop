<!DOCTYPE html>
<html>
<head>
    <title>Secure Remote Access</title>
    <style>
        body { background: #121212; color: #e0e0e0; text-align: center; font-family: 'Segoe UI', sans-serif; margin: 0; overflow: hidden; }
        .header { background: #1f1f1f; padding: 10px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; padding: 10px 20px; }
        
        /* The Canvas (Screen) - Hidden by default */
        canvas { 
            margin-top: 10px;
            box-shadow: 0 0 30px rgba(0,0,0,0.7); 
            cursor: crosshair; 
            background: #000;
            outline: none;
            
            /* CRITICAL for pixel-perfect upscaling */
            image-rendering: optimizeQuality; 
            
            display: none; 
        }

        /* The Login Box Overlay */
        #loginOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95);
            display: flex; justify-content: center; align-items: center;
            flex-direction: column;
            z-index: 1000;
        }
        
        input { padding: 12px; font-size: 18px; border-radius: 5px; border: none; margin-bottom: 15px; width: 250px; text-align: center;}
        button { padding: 12px 30px; font-size: 18px; cursor: pointer; background: #4caf50; color: white; border: none; border-radius: 5px; font-weight: bold; transition: background 0.3s;}
        button:hover { background: #45a049; }
        
        .status { color: #888; font-weight: bold; }
    </style>
</head>
<body>
    <div class="header">
        <strong>Business Remote Support (Secured)</strong>
        <div id="status" class="status">Locked</div>
    </div>
    
    <div id="loginOverlay">
        <h2 style="margin-bottom: 20px;">ðŸ”’ Protected Session</h2>
        <input type="password" id="passwordInput" placeholder="Enter Password" onkeydown="if(event.key==='Enter') connect()">
        <button onclick="connect()">Connect</button>
        <div id="loginMsg" style="margin-top: 15px; color: #ff5555; font-weight: bold;"></div>
    </div>

    <canvas id="screenCanvas" tabindex="0"></canvas>

    <script>
        // --- CONFIGURATION ---
        // 1. For LAN Test: Use your IP (e.g., 'ws://192.168.1.X:8080')
        // 2. For Internet: Use Ngrok (e.g., 'wss://xxxx.ngrok-free.app')
        
        const SERVER_URL = 'wss://misunderstandingly-prebuccal-linh.ngrok-free.dev'; 
        // ---------------------

        const canvas = document.getElementById('screenCanvas');
        const ctx = canvas.getContext('2d');
        const status = document.getElementById('status');
        const loginOverlay = document.getElementById('loginOverlay');
        const msg = document.getElementById('loginMsg');
        let ws = null;

        function connect() {
            const pass = document.getElementById('passwordInput').value;
            if (!pass) { msg.innerText = "Please enter a password."; return; }

            msg.innerText = "Connecting...";
            msg.style.color = "#ccc";

            ws = new WebSocket(SERVER_URL);
            ws.binaryType = 'blob'; 

            ws.onopen = () => {
                // STEP 1: Send Password immediately
                ws.send("AUTH:" + pass);
                status.innerText = "Verifying Credentials...";
            };
            
            ws.onmessage = (event) => {
                // STEP 2: If we receive data, it means Auth was successful!
                if (event.data instanceof Blob) {
                    
                    // Hide Login / Show Screen
                    if (loginOverlay.style.display !== "none") {
                        loginOverlay.style.display = "none";
                        canvas.style.display = "block";
                        status.innerText = "ONLINE - Secure Connection";
                        status.style.color = "#00ff00";
                        canvas.focus();
                    }

                    // Render Image
                    const url = URL.createObjectURL(event.data);
                    const img = new Image();
                    img.onload = () => {
                        if (canvas.width !== img.width) {
                            canvas.width = img.width;
                            canvas.height = img.height;
                        }
                        ctx.drawImage(img, 0, 0);
                        URL.revokeObjectURL(url);
                    };
                    img.src = url;
                }
            };

            ws.onclose = () => {
                status.innerText = "DISCONNECTED";
                status.style.color = "red";
                
                // Reset UI to Login Screen
                loginOverlay.style.display = "flex";
                canvas.style.display = "none";
                msg.innerText = "Connection Failed. (Check Password or Server)";
                msg.style.color = "#ff5555";
            };

            setupInputs();
        }

        function setupInputs() {
            // MOUSE
            canvas.addEventListener('mousedown', (e) => {
                if(!ws || ws.readyState !== WebSocket.OPEN) return;
                if(e.button === 2) e.preventDefault();
                
                const rect = canvas.getBoundingClientRect();
                const x = (e.clientX - rect.left) * (canvas.width / rect.width);
                const y = (e.clientY - rect.top) * (canvas.height / rect.height);
                
                ws.send(JSON.stringify({ 
                    action: "click", x: Math.round(x), y: Math.round(y),
                    button: e.button === 2 ? "right" : "left"
                }));
            });
            canvas.addEventListener('contextmenu', event => event.preventDefault());

            // KEYBOARD
            canvas.addEventListener('keydown', (e) => {
                if(!ws || ws.readyState !== WebSocket.OPEN) return;
                e.preventDefault();
                ws.send(JSON.stringify({ action: "key", key: e.key }));
            });
        }
    </script>
</body>
</html>